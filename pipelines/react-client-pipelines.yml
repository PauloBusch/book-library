# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- none

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '0673b67c-abfa-4fe6-bc3d-eaa292bdd89f'
  imageRepository: 'react-client-image'
  containerRegistry: 'booklibraryacr.azurecr.io'
  deploymentFileName: 'react-client-deployment.yaml'
  dockerfilePath: '$(Build.SourcesDirectory)/book-library-client/Dockerfile'
  tag: '$(Build.BuildId)'

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

pool:
  vmImage: $(vmImageName)

steps:
- task: Docker@2
  displayName: Build and push image to ACR
  inputs:
    command: buildAndPush
    repository: $(imageRepository)
    dockerfile: $(dockerfilePath)
    containerRegistry: $(dockerRegistryServiceConnection)
    tags: |
      $(tag)
      
- task: CopyFiles@2
  displayName: Copy kubernetes $(deploymentFileName) to staging
  inputs:
    SourceFolder: 'kubernetes'
    Contents: $(deploymentFileName)
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
  
- task: PublishBuildArtifacts@1
  displayName: Publish build artifacts to staging
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'deploy'
    publishLocation: 'Container'